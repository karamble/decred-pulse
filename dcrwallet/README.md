# dcrwallet Docker Setup

This directory contains the Docker configuration for running [dcrwallet](https://github.com/decred/dcrwallet) as part of the Decred Pulse project.

## Overview

The dcrwallet service is set up to run as a **watch-only wallet**, meaning it can:
- Import extended public keys (xpub)
- Monitor balances and transactions
- Generate receiving addresses
- **Cannot** sign transactions or spend funds

## Architecture

- **Base Image**: `golang:1.21-alpine` (builder) â†’ `alpine:latest` (runtime)
- **User**: Non-root `dcrwallet` user
- **Data Directory**: `/home/dcrwallet/.dcrwallet`
- **RPC Certificates**: Shared from dcrd via volume mount (read-only)
- **Ports**: 
  - 9110: RPC (mainnet)
  - 9111: gRPC (mainnet)
  - 19110: RPC (testnet)
  - 19111: gRPC (testnet)

## First-Time Setup

### Automatic Wallet Creation

On first launch (when no `wallet.db` exists), the entrypoint script automatically:

1. Generates a secure random passphrase (32-byte base64)
2. Stores the passphrase in `.dcrwallet/.passphrase` (permissions: 600)
3. Creates a new wallet with:
   - Private passphrase: [generated secure password]
   - Public passphrase: no
   - New seed generation (displayed in logs for backup)
4. Starts dcrwallet and auto-unlocks with stored passphrase

**Important**: The seed is displayed in the container logs on first run. While this is a watch-only wallet and the seed isn't required for operation, you should save it for backup purposes:

```bash
docker logs decred-pulse-dcrwallet | grep -A 5 "WALLET SEED"
```

### Importing xpub Keys

After the wallet is created, import your extended public key via the web interface:

1. Navigate to the Wallet dashboard
2. Click "Add X-Pub" button
3. Paste your xpub key (must start with "dpub" for Decred mainnet)
4. Choose to rescan the blockchain (recommended for first import)

## Subsequent Launches

When `wallet.db` already exists:

1. Entrypoint script detects existing wallet
2. Reads passphrase from `.dcrwallet/.passphrase`
3. Starts dcrwallet
4. Auto-unlocks wallet using stored passphrase

## Configuration

### Environment Variables

Set via `docker-compose.yml`:

- `DCRWALLET_RPC_USER`: RPC username (default: dcrwallet)
- `DCRWALLET_RPC_PASS`: RPC password
- `DCRD_RPC_USER`: dcrd RPC username
- `DCRD_RPC_PASS`: dcrd RPC password
- `DCRD_RPC_HOST`: dcrd hostname (default: dcrd)

### Build Arguments

- `DCRWALLET_VERSION`: Git branch/tag to build (default: master)

Example:
```bash
docker-compose build --build-arg DCRWALLET_VERSION=release-v4.0.0 dcrwallet
```

## Security Considerations

### Passphrase Storage

The private passphrase is stored in `/home/dcrwallet/.dcrwallet/.passphrase`:
- File permissions: 600 (owner read/write only)
- Owned by `dcrwallet` user inside container
- Persisted in Docker volume `dcrwallet-data`
- **Not exposed** in environment variables or command-line arguments

### RPC Certificate Sharing

dcrwallet uses the same TLS certificates as dcrd:
- Certificates generated by dcrd on first run
- Shared via Docker volume `dcrd-certs`
- dcrwallet mounts volume as **read-only**
- Ensures secure TLS communication

### Watch-Only Wallet

This setup creates a watch-only wallet by default:
- Extended public keys (xpub) are imported
- Can monitor but **cannot spend**
- Safe for monitoring and receiving addresses
- Private keys never touch the wallet

## Troubleshooting

### Wallet Creation Failed

If wallet creation fails on first run:

```bash
# Check logs
docker logs decred-pulse-dcrwallet

# Remove wallet data and try again
docker-compose down
docker volume rm decred-pulse_dcrwallet-data
docker-compose up dcrwallet
```

### RPC Connection Issues

If wallet cannot connect to dcrd:

```bash
# Verify dcrd is running and healthy
docker-compose ps dcrd

# Check if certificates exist
docker exec decred-pulse-dcrwallet ls -la /certs/

# Verify network connectivity
docker exec decred-pulse-dcrwallet ping -c 3 dcrd
```

### Passphrase Lost

If the passphrase file is lost but wallet.db exists:

1. Back up current wallet.db (contains imported xpub data)
2. Remove wallet data volume
3. Restart to create new wallet
4. Re-import xpub keys

```bash
# Backup wallet.db
docker cp decred-pulse-dcrwallet:/home/dcrwallet/.dcrwallet/mainnet/wallet.db ./wallet.db.backup

# Reset
docker-compose down
docker volume rm decred-pulse_dcrwallet-data
docker-compose up dcrwallet
```

## Manual Wallet Operations

### Using dcrctl

Access wallet via dcrctl:

```bash
# Get wallet info
docker exec decred-pulse-dcrwallet dcrctl \
  --wallet \
  --rpcuser=dcrwallet \
  --rpcpass=your_password \
  --rpcserver=127.0.0.1:9110 \
  --rpccert=/certs/rpc.cert \
  walletinfo

# List accounts
docker exec decred-pulse-dcrwallet dcrctl \
  --wallet \
  --rpcuser=dcrwallet \
  --rpcpass=your_password \
  --rpcserver=127.0.0.1:9110 \
  --rpccert=/certs/rpc.cert \
  listaccounts

# Get balance
docker exec decred-pulse-dcrwallet dcrctl \
  --wallet \
  --rpcuser=dcrwallet \
  --rpcpass=your_password \
  --rpcserver=127.0.0.1:9110 \
  --rpccert=/certs/rpc.cert \
  getbalance
```

### Shell Access

Open shell in dcrwallet container:

```bash
docker exec -it decred-pulse-dcrwallet /bin/sh
```

## Data Persistence

Wallet data is stored in Docker volume `dcrwallet-data`:

- Location inside container: `/home/dcrwallet/.dcrwallet`
- Contains:
  - `wallet.db`: Wallet database (xpub data, addresses, transactions)
  - `.passphrase`: Encrypted passphrase file
  - `mainnet/` or `testnet/`: Network-specific data
  - Log files

### Backup

```bash
# Create backup
docker run --rm \
  -v decred-pulse_dcrwallet-data:/data \
  -v $(pwd)/backups:/backup \
  alpine tar czf /backup/dcrwallet-backup-$(date +%Y%m%d-%H%M%S).tar.gz -C /data .
```

### Restore

```bash
# Restore from backup
docker-compose down dcrwallet
docker run --rm \
  -v decred-pulse_dcrwallet-data:/data \
  -v $(pwd)/backups:/backup \
  alpine sh -c "rm -rf /data/* && tar xzf /backup/dcrwallet-backup-xxx.tar.gz -C /data"
docker-compose up -d dcrwallet
```

## References

- [dcrwallet GitHub](https://github.com/decred/dcrwallet)
- [dcrwallet Documentation](https://docs.decred.org/wallets/cli/dcrwallet-setup/)
- [Decred Documentation](https://docs.decred.org/)

